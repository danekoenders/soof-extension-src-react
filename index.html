<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React + TS</title>
  </head>
  <body>
    <script type="module" src="/src/main.tsx"></script>

    <soof-chat
      local-language="{{ localization.language.iso_code }}"
      primary-color="rgb(26 50 99)"
      secondary-color="rgb(76 76 94)"
    ></soof-chat>

    <script type="module" defer>
      class ChatBot extends HTMLElement {
        constructor() {
          super();
          this.attachShadow({ mode: "open" });
          this.isOpen = false;
          this.bundleLoaded = false;
          this.reactMount = null;
          this.button = null;
          this.window = null;
          this.handleButtonClick = this.handleButtonClick.bind(this);
          this.handleCloseClick = this.handleCloseClick.bind(this);
          this.renderBase();
        }

        handleButtonClick() {
          if (!this.isOpen) {
            this.openChatWindow();
          }
        }

        handleCloseClick() {
          this.closeChatWindow();
        }

        async openChatWindow() {
          if (!this.isOpen) {
            // await this.loadBundle();
            this.isOpen = true;
            this.renderBase();

            // Now that renderBase has placed <div id="laintern-agent-react-root">
            const config = this.getConfig();
            if (window.__lainternAgentMount) {
              window.__lainternAgentMount(this.shadowRoot, config);
            } else {
              console.error("Could not find __lainternAgentMount on window");
            }
          }
        }

        closeChatWindow() {
          if (this.isOpen) {
            this.isOpen = false;
            this.renderBase();
          }
        }

        getConfig() {
          return {
            type: "widget",
            language: "en",
            primaryColor: "rgb(26 50 99)",
            secondaryColor: "rgb(76 76 94)",
          };
        }

        renderBase() {
          this.shadowRoot.innerHTML = "";
          const style = document.createElement("style");
          style.textContent = `
      .soof-chat-btn {
        position: fixed;
        bottom: 32px;
        right: 32px;
        z-index: 999999;
        background: #fff;
        border-radius: 50%;
        width: 64px;
        height: 64px;
        box-shadow: 0 2px 16px rgba(0,0,0,0.18);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: none;
        transition: box-shadow 0.2s;
      }
      .soof-chat-btn:hover {
        box-shadow: 0 4px 24px rgba(0,0,0,0.22);
      }
      .soof-chat-btn.close-mode {
        font-size: 32px;
        line-height: 1;
        font-weight: 300;
        color: #333;
        z-index: 10000000;
      }
      .soof-chat-window {
        /* Window container - main.tsx will handle the actual overlay styling */
        /* This class is just for identification, styling is done by React */
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      @keyframes laintern-agent-fade-in {
        from { opacity: 0; transform: translateY(40px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @media (max-width: 600px) {
        .soof-chat-window {
          width: 100vw;
          height: 100vh;
          bottom: 0;
          right: 0;
          border-radius: 0;
        }
        /* Hide floating button when chat is open on mobile (button has data-chat-open attribute) */
        .soof-chat-btn[data-chat-open="true"] {
          display: none !important;
        }
        .soof-chat-btn {
          right: 16px;
          bottom: 16px;
        }
      }
    `;
          this.shadowRoot.appendChild(style);

          // Always show the floating button, but change its appearance and behavior based on state
          // On desktop: show as close button (X) when chat is open
          // On mobile: button is hidden when chat is open (via CSS data attribute)
          this.button = document.createElement("button");
          this.button.className = "soof-chat-btn";
          
          if (!this.isOpen) {
            // Chat closed: show chat icon (visible on mobile and desktop)
            this.button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><path d="M2 15V5c0-1.1.9-2 2-2h16a2 2 0 0 1 2 2v15a1 1 0 0 1-1.7.7L16.58 17H4a2 2 0 0 1-2-2z"/><path d="M6 7h12a1 1 0 0 1 0 2H6a1 1 0 1 1 0-2zm0 4h8a1 1 0 0 1 0 2H6a1 1 0 0 1 0-2z"/></svg>`;
            this.button.setAttribute("data-chat-open", "false");
            this.button.addEventListener("click", this.handleButtonClick);
            this.shadowRoot.appendChild(this.button);
          } else {
            // Chat open: show close icon (X) for desktop, but hide on mobile
            this.button.innerHTML = "&times;";
            this.button.classList.add("close-mode");
            this.button.setAttribute("data-chat-open", "true");
            this.button.addEventListener("click", this.handleCloseClick);
            
            // Chat window - React will handle the header close button for mobile
            this.window = document.createElement("div");
            this.window.className = "soof-chat-window";
            // React mount point
            this.reactMount = document.createElement("div");
            this.reactMount.id = "laintern-agent-react-root";
            this.window.appendChild(this.reactMount);
            this.shadowRoot.appendChild(this.window);
            
            // Append button (CSS will hide it on mobile when data-chat-open="true")
            this.shadowRoot.appendChild(this.button);
          }
        }

        // Expose a mount point for React (main.tsx expects shadowRoot and a div inside)
        connectedCallback() {
          // No-op, handled in constructor
        }
      }

      if (!customElements.get("soof-chat")) {
        customElements.define("soof-chat", ChatBot);
      }
    </script>
  </body>
</html>
