<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React + TS</title>
  </head>
  <body>
    <script type="module" src="/src/main.tsx"></script>

    <soof-chat
      local-language="{{ localization.language.iso_code }}"
      primary-color="rgb(26 50 99)"
      secondary-color="rgb(76 76 94)"
    ></soof-chat>

    <script type="module" defer>
      class ChatBot extends HTMLElement {
        constructor() {
          super();
          this.attachShadow({ mode: "open" });
          this.isOpen = false;
          this.bundleLoaded = false;
          this.reactMount = null;
          this.button = null;
          this.window = null;
          this.handleButtonClick = this.handleButtonClick.bind(this);
          this.handleCloseClick = this.handleCloseClick.bind(this);
          this.renderBase();
        }

        handleButtonClick() {
          if (!this.isOpen) {
            this.openChatWindow();
          }
        }

        handleCloseClick() {
          this.closeChatWindow();
        }

        async openChatWindow() {
          if (!this.isOpen) {
            // await this.loadBundle();
            this.isOpen = true;
            this.renderBase();

            // Now that renderBase has placed <div id="laintern-agent-react-root">
            const config = this.getConfig();
            if (window.__lainternAgentMount) {
              window.__lainternAgentMount(this.shadowRoot, config);
            } else {
              console.error("Could not find __lainternAgentMount on window");
            }
          }
        }

        closeChatWindow() {
          if (this.isOpen) {
            this.isOpen = false;
            this.renderBase();
          }
        }

        getConfig() {
          return {
            type: "widget",
            language: "en",
            primaryColor: "rgb(26 50 99)",
            secondaryColor: "rgb(76 76 94)",
            useCircularButton: false,
            buttonText: "Ask our AI",
            buttonBackgroundColor: "#ffffff",
            invertButtonColors: false
          };
        }

        renderBase() {
          this.shadowRoot.innerHTML = "";
          const style = document.createElement("style");
          style.textContent = `
      /* Circular button styles */
      .soof-chat-btn.circular {
        position: fixed;
        bottom: 32px;
        right: 32px;
        z-index: 999999;
        border-radius: 50%;
        width: 64px;
        height: 64px;
        box-shadow: 0 2px 16px rgba(0,0,0,0.18);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: none;
        transition: box-shadow 0.2s;
        font-weight: 300;
      }
      .soof-chat-btn.circular:hover {
        box-shadow: 0 4px 24px rgba(0,0,0,0.22);
      }
      
      /* Horizontal button styles */
      .soof-chat-btn.horizontal {
        position: fixed;
        bottom: 32px;
        right: 32px;
        z-index: 999999;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 32px;
        padding: 12px 24px 12px 20px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12), 
                    0 0 0 1px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 15px;
        font-weight: 600;
        white-space: nowrap;
      }
      .soof-chat-btn.horizontal:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 32px rgba(0, 0, 0, 0.16), 
                    0 0 0 1px rgba(0, 0, 0, 0.08);
      }
      .soof-chat-btn.horizontal .icon-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
      }
      .soof-chat-btn.horizontal .icon-wrapper svg {
        width: 100%;
        height: 100%;
      }
      .soof-chat-btn.horizontal .button-text {
        line-height: 1;
      }
      
      /* Close button styles - circular, same dimensions as horizontal */
      .soof-chat-btn.close {
        position: fixed;
        bottom: 32px;
        right: 32px;
        z-index: 999999;
        border-radius: 50%;
        width: 52px;
        height: 52px;
        box-shadow: 0 2px 16px rgba(0,0,0,0.18);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: none;
        transition: box-shadow 0.2s;
        font-size: 32px;
        line-height: 1;
        font-weight: 300;
      }
      .soof-chat-btn.close:hover {
        box-shadow: 0 4px 24px rgba(0,0,0,0.22);
      }
      .soof-chat-window {
        /* Window container - main.tsx will handle the actual overlay styling */
        /* This class is just for identification, styling is done by React */
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      @keyframes laintern-agent-fade-in {
        from { opacity: 0; transform: translateY(40px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @media (max-width: 600px) {
        .soof-chat-window {
          width: 100vw;
          height: 100vh;
          bottom: 0;
          right: 0;
          border-radius: 0;
        }
        /* Hide floating button when chat is open on mobile (button has data-chat-open attribute) */
        .soof-chat-btn[data-chat-open="true"] {
          display: none !important;
        }
        .soof-chat-btn.circular {
          right: 16px;
          bottom: 16px;
        }
        .soof-chat-btn.horizontal {
          bottom: 16px;
          right: 16px;
          padding: 10px 20px 10px 16px;
          font-size: 14px;
          gap: 8px;
        }
        .soof-chat-btn.close {
          bottom: 16px;
          right: 16px;
        }
      }
    `;
          this.shadowRoot.appendChild(style);

          // Always show the floating button, but change its appearance and behavior based on state
          // On desktop: show as close button (X) when chat is open
          // On mobile: button is hidden when chat is open (via CSS data attribute)
          this.button = document.createElement("button");
          const config = this.getConfig();
          const isCircular = config.useCircularButton;
          const invertColors = config.invertButtonColors;
          const primaryColor = config.primaryColor;
          const bgColor = config.buttonBackgroundColor || '#ffffff';
          
          // Determine colors based on invert setting
          const buttonBg = invertColors ? primaryColor : bgColor;
          const buttonColor = invertColors ? bgColor : primaryColor;
          
          // Simple helper to add opacity to color
          const addOpacity = (color, opacity) => {
            // If already rgba/rgb, extract rgb and rebuild with new opacity
            const rgbMatch = color.match(/\d+/g);
            if (rgbMatch && rgbMatch.length >= 3) {
              return `rgba(${rgbMatch[0]}, ${rgbMatch[1]}, ${rgbMatch[2]}, ${opacity})`;
            }
            // If hex, convert to rgb
            if (color.startsWith('#')) {
              const hex = color.slice(1);
              const r = parseInt(hex.slice(0, 2), 16);
              const g = parseInt(hex.slice(2, 4), 16);
              const b = parseInt(hex.slice(4, 6), 16);
              return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
            return color;
          };
          
          if (!this.isOpen) {
            // Chat closed: show appropriate button style
            this.button.className = isCircular ? 'soof-chat-btn circular' : 'soof-chat-btn horizontal';
            
            if (isCircular) {
              // Circular button: show chat icon (solid background)
              this.button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="currentColor"><path d="M2 15V5c0-1.1.9-2 2-2h16a2 2 0 0 1 2 2v15a1 1 0 0 1-1.7.7L16.58 17H4a2 2 0 0 1-2-2z"/><path d="M6 7h12a1 1 0 0 1 0 2H6a1 1 0 1 1 0-2zm0 4h8a1 1 0 0 1 0 2H6a1 1 0 0 1 0-2z"/></svg>`;
              // Solid background for circular button
              this.button.style.backgroundColor = buttonBg;
            } else {
              // Horizontal button: show twinkle icon + text (transparent background with blur)
              const twinkleIcon = `<svg width="13" height="13" viewBox="0 0 13 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2.47804 0.724976L3.03876 2.56896L4.95609 3.10822L3.03876 3.64749L2.47804 5.49147L1.91733 3.64749L0 3.10822L1.91733 2.56896L2.47804 0.724976Z" fill="currentColor"/>
                <path d="M7.37144 1.89856L8.64503 6.0869L13 7.31177L8.64503 8.53664L7.37144 12.725L6.09785 8.53664L1.74292 7.31177L6.09785 6.0869L7.37144 1.89856Z" fill="currentColor"/>
              </svg>`;
              this.button.innerHTML = `
                <div class="icon-wrapper">${twinkleIcon}</div>
                <span class="button-text">${config.buttonText || 'Ask our AI'}</span>
              `;
              // Transparent background for horizontal button (glass morphism effect)
              this.button.style.backgroundColor = addOpacity(buttonBg, 0.85);
              // Add hover effect to increase opacity
              this.button.addEventListener('mouseenter', () => {
                this.button.style.backgroundColor = addOpacity(buttonBg, 0.95);
              });
              this.button.addEventListener('mouseleave', () => {
                this.button.style.backgroundColor = addOpacity(buttonBg, 0.85);
              });
            }
            
            // Apply text/icon color
            this.button.style.color = buttonColor;
            
            this.button.setAttribute("data-chat-open", "false");
            this.button.addEventListener("click", this.handleButtonClick);
            this.shadowRoot.appendChild(this.button);
          } else {
            // Chat open: show close icon (X) for desktop, but hide on mobile
            // Use close button class (same size as horizontal, but circular)
            this.button.className = 'soof-chat-btn close';
            this.button.innerHTML = "&times;";
            
            // Apply same colors as main button
            this.button.style.backgroundColor = buttonBg;
            this.button.style.color = buttonColor;
            
            this.button.setAttribute("data-chat-open", "true");
            this.button.addEventListener("click", this.handleCloseClick);
            
            // Chat window - React will handle the header close button for mobile
            this.window = document.createElement("div");
            this.window.className = "soof-chat-window";
            // React mount point
            this.reactMount = document.createElement("div");
            this.reactMount.id = "laintern-agent-react-root";
            this.window.appendChild(this.reactMount);
            this.shadowRoot.appendChild(this.window);
            
            // Append button (CSS will hide it on mobile when data-chat-open="true")
            this.shadowRoot.appendChild(this.button);
          }
        }

        // Expose a mount point for React (main.tsx expects shadowRoot and a div inside)
        connectedCallback() {
          // No-op, handled in constructor
        }
      }

      if (!customElements.get("soof-chat")) {
        customElements.define("soof-chat", ChatBot);
      }
    </script>
  </body>
</html>
